<head>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
</head>

<table class='table'>
	<thead>
		<tr> <th>Container Id</th> <th>Exposed Port</th> <th>Accessible</th> <th></th></tr>
	</thead>
	<tbody id='containers_table'>
	</tbody>
</table>

<hr> 
<form>
	<input placeholder='port (81,100,10000)' type='' id='newPortInput' />
	<button onclick='addPort()' type='button' id='newPortButton'>Spin up new Port</button>
</form>
* Open ports will automatically close after 5 minutes from opening.
<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
<script>

function fetchContainers(){

  let containersTable = "";

  var settings = {
    "url": "/api/listContainers",
    "method": "GET",
    "timeout": 0,
    "headers": {
      "Content-Type": "application/json"
    },
    "data": JSON.stringify({
      "port": 28
    }),
  };

  $.ajax(settings).done(function (response) {
    containers = response;
    containerCount = containers.length;

    for(containerId in containers){
    let container = containers[containerId];
    let exposed = container.exposedPorts;
    const publicPorts = [];

    exposed.forEach(item => {
      if (item.hostPort && item.hostPort.PublicPort) {
          publicPorts.push(item.hostPort.PublicPort);
      }
    });

    let container_id = container.id;
    if(!publicPorts.length){ 
      publicPorts[0] = "broken container"; 
      containerCount --;
      //containersTable += "<tr><td>"+container_id+"</td><td>Uhoh</td><td></td><td></td></tr>";
    }else{
      containersTable += "<tr><td>"+container_id+"</td><td><a href='" + window.location.origin + ":"+publicPorts[0]+"' target='_blank'>" + publicPorts[0] + "</a></td><td id='accessible_"+container_id+"'>Checking...</td><td><button class='btn btn-danger' onclick='closePort(\""+container_id+"\")'>Kill</button></td></tr>";
      checkFileExistence(window.location.origin + ":" + publicPorts[0], 'favicon.png').then(fileExists => { if(fileExists){ $("#accessible_"+container_id).html("Yes"); } })
    }

  }

  if(!containerCount){
  containersTable += "<tr><td colspan='4'><center>No Open Ports</center></td></tr>";
  }

  $("#containers_table").html(containersTable);

    console.log(response);
  });

}

function isIntegerInRange(input) {
    var number = parseInt(input, 10);
    return !isNaN(number) && Number.isInteger(number) && number >= 0 && number <= 65535;
}

function addPort(checked=false){

  if(!checked){
    checkExist(document.getElementById("newPortInput").value);
    return;
  }

  let port = document.getElementById("newPortInput").value;



  if(!isIntegerInRange(port)){
    alert("Port must be an integer within 1-65535");
    return;
  }

  var settings = {
    "url": "/api/startContainer",
    "method": "POST",
    "timeout": 0,
    "headers": {
      "Content-Type": "application/json"
    },
    "data": JSON.stringify({
      "port": port
    }),
  };

  $.ajax(settings).done(function (response) {
    $("newPortInput").val("");
    fetchContainers();
    console.log(response);
  });
}


function closePort(id){
  var settings = {
    "url": "/api/killContainer/" + id,
    "method": "DELETE",
    "timeout": 0,
    "headers": {
      "Content-Type": "application/json"
    },
  };
  $.ajax(settings).done(function (response) {
    console.log(response);
    fetchContainers();
  });
}

function checkExist(port){
  var settings = {
    "url": "/api/checkPort/" + port,
    "method": "GET",
    "timeout": 0,
    "headers": {
      "Content-Type": "application/json"
    },            
  };

  $.ajax(settings).done(function (response) {
    console.log(response);
    if(!response.isPortExposed){
      addPort(true);
    }else{
      alert("This port is already listening");
    }
  });

}

async function checkFileExistence(server, file) {
  const fileUrl = `${server}/${file}`;
  try {
    const response = await fetch(fileUrl, { method: 'HEAD' });

    if (response.status === 200) {
      return true; // The file exists if the response status is 200 OK.
    } else {
      return false;
    }
  } catch (error) {
    console.error('An error occurred:', error);
    return false; // An error occurred, so we assume the file does not exist.
  }
}


fetchContainers();
setInterval(function () { fetchContainers(); }, 5000);

</script>
